{% extends 'base.html.twig' %}

{% block title %}Arbre Généalogique{% endblock %}

{% block body %}
<div class="row gy-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="mb-0" style="color: white; font-size: 1.75rem;">
                            <i class="fas fa-tree"></i> Arbre Généalogique
                        </h1>
                        <p class="text-white-50 mb-0 mt-2">Explorez votre histoire familiale</p>
                    </div>
                    <a href="{{ path('personne_new') }}" class="btn btn-light">
                        <i class="fas fa-user-plus"></i> Ajouter une personne
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <p class="text-muted mb-0">
                        <i class="fas fa-users"></i> 
                        <strong>{{ personnes|length }}</strong> personne{{ personnes|length > 1 ? 's' : '' }} enregistrée{{ personnes|length > 1 ? 's' : '' }}
                    </p>
                    <div>
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            Cliquez sur un nœud pour le sélectionner
                        </small>
                    </div>
                </div>

                <div id="tree" style="height: 800px; border: 2px solid #E5E7EB; border-radius: 8px; background: linear-gradient(135deg, #FFFFFF 0%, #F9FAFB 100%);"></div>

                <div class="mt-4 pt-3 border-top">
                    <div class="mb-4 d-flex flex-wrap align-items-center gap-1">
                        <span class="badge" style="background: linear-gradient(135deg, #F5F3FF 0%, #EFF6FF 100%); color: #6B21A8; border: 1px solid #D8B4FE;">
                            <i class="fas fa-info-circle"></i> Double-clic = Éditer
                        </span>
                    </div>
                    
                    <h6 class="mb-3"><i class="fas fa-key"></i> Légende des générations</h6>
                    <div class="d-flex flex-wrap align-items-center gap-2">
                        <span class="badge badge-primary">
                            <i class="fas fa-link"></i> Lien parent-enfant
                        </span>

                        <span class="badge badge-danger">
                            <i class="fas fa-heart"></i> Lien conjugal
                        </span>
                    </div>
                    <div class="d-flex flex-wrap align-items-center gap-1 mt-3">
                        {% set uniqueGenerations = {} %}

                        {% for p in personnes %}
                            {% if p.generation %}
                                {% set name = p.generation.generationName %}
                                {% set order = p.generation.displayOrder|number_format(0, '', '') %}

                                {% if uniqueGenerations[name] is not defined %}
                                    {% set uniqueGenerations = uniqueGenerations|merge({ (name): order }) %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}

                        {% for name, order in uniqueGenerations|sort %}
                            <small class="d-inline-flex align-items-center gap-1 border rounded px-2 py-1"
                                style="background: #F9FAFB;">
                                {% if order == '0' %}
                                    <span style="display:inline-block;width:16px;height:16px;background:#DBEAFE;border:2px solid #0284C7;border-radius:2px;"></span>
                                {% elseif order == '1' %}
                                    <span style="display:inline-block;width:16px;height:16px;background:#BAE6FD;border:2px solid #0369A1;border-radius:2px;"></span>
                                {% elseif order == '2' %}
                                    <span style="display:inline-block;width:16px;height:16px;background:#7DD3FC;border:2px solid #0284C7;border-radius:2px;"></span>
                                {% elseif order == '3' %}
                                    <span style="display:inline-block;width:16px;height:16px;background:#FED7AA;border:2px solid #EA580C;border-radius:2px;"></span>
                                {% elseif order == '4' %}
                                    <span style="display:inline-block;width:16px;height:16px;background:#FDBA74;border:2px solid #D97706;border-radius:2px;"></span>
                                {% elseif order == '5' %}
                                    <span style="display:inline-block;width:16px;height:16px;background:#FB923C;border:2px solid #B45309;border-radius:2px;"></span>
                                {% elseif order == '6' %}
                                    <span style="display:inline-block;width:16px;height:16px;background:#F97316;border:2px solid #9A3412;border-radius:2px;"></span>
                                {% elseif order == '7' %}
                                    <span style="display:inline-block;width:16px;height:16px;background:#DC2626;border:2px solid #7F1D1D;border-radius:2px;"></span>
                                {% elseif order == '8' %}
                                    <span style="display:inline-block;width:16px;height:16px;background:#BE185D;border:2px solid #500724;border-radius:2px;"></span>
                                {% elseif order == '9' %}
                                    <span style="display:inline-block;width:16px;height:16px;background:#6B21A8;border:2px solid #2D0A4E;border-radius:2px;"></span>
                                {% else %}
                                    <span style="display:inline-block;width:16px;height:16px;background:#E5E7EB;border:2px solid #6B7280;border-radius:2px;"></span>
                                {% endif %}

                                <strong>{{ name }}</strong>
                            </small>
                        {% endfor %}
                    </div>
                </div>

                <div class="mt-4 d-flex gap-2 justify-content-end">
                    <a href="{{ path('generations_list') }}" class="btn btn-info">
                        <i class="fas fa-layer-group"></i> Gérer les générations
                    </a>
                    <a href="{{ path('family_list') }}" class="btn btn-secondary">
                        <i class="fas fa-list"></i> Vue liste
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Construction d'une structure JS à partir des données Twig
    const personnes = [
    {% for p in personnes %}
    {
        id: {{ p.id }},
        prenom: "{{ p.prenom }}",
        nom: "{{ p.nom }}",
        mort: {{ p.mort ? 'true' : 'false' }},
        displayOrder: {{ p.generation ? p.generation.displayOrder : 0 }},
        generationName: "{{ p.generation ? p.generation.generationName : 'Génération inconnue' }}",
        pere: {{ p.pere ? p.pere.id : 'null' }},
        mere: {{ p.mere ? p.mere.id : 'null' }},
        partenaires: [{% for pr in p.partenaires %}{{ pr.id }}{{ not loop.last ? ', ' : '' }}{% endfor %}]
    }{{ not loop.last ? ',' : '' }}
    {% endfor %}
    ];

    // Couleurs par ordre d'affichage
    const generationColors = {
        0: { bg: '#DBEAFE', border: '#0284C7', text: '#0C4A6E' },  // Bleu ciel
        1: { bg: '#BAE6FD', border: '#0369A1', text: '#082F49' },  // Bleu moyen
        2: { bg: '#7DD3FC', border: '#0284C7', text: '#082F49' },  // Bleu vif
        3: { bg: '#FED7AA', border: '#EA580C', text: '#7C2D12' },  // Orange clair
        4: { bg: '#FDBA74', border: '#D97706', text: '#5B21B6' },  // Orange moyen
        5: { bg: '#FB923C', border: '#B45309', text: '#7C2D12' },  // Orange foncé
        6: { bg: '#F97316', border: '#9A3412', text: '#FFFFFF' },  // Orange très foncé
        7: { bg: '#DC2626', border: '#7F1D1D', text: '#FFFFFF' },  // Rouge
        8: { bg: '#BE185D', border: '#500724', text: '#FFFFFF' },  // Rose
        9: { bg: '#6B21A8', border: '#2D0A4E', text: '#FFFFFF' }   // Violet
    };

    function getGenerationColor(personId) {
        const person = personnes.find(p => p.id === personId);
        const order = Math.min(person.displayOrder, 9);
        return generationColors[order] || generationColors[0];
    }

    // Création des nœuds avec rectangles
    const nodes = new vis.DataSet(
        personnes.map(p => {
            const colors = getGenerationColor(p.id);
            const displayLabel = p.prenom + '\n' + p.nom + (p.mort ? '\n(✝)' : '');
            
            return {
                id: p.id,
                label: displayLabel,
                title: '<div style="font-weight: 700; font-size: 14px;">' + p.prenom + ' ' + p.nom + '</div><div style="color: #6B7280; margin-top: 5px;"><strong>' + p.generationName + '</strong></div>',
                shape: 'box',
                margin: {
                    top: 15,
                    right: 15,
                    bottom: 15,
                    left: 15
                },
                widthConstraint: {
                    maximum: 180
                },
                font: {
                    size: 16,
                    bold: true,
                    color: colors.text,
                    multi: true,
                    align: 'center'
                },
                color: {
                    background: colors.bg,
                    border: colors.border,
                    highlight: {
                        background: '#FFFFFF',
                        border: '#4338CA'
                    }
                },
                // place nodes by generation (même génération -> même niveau)
                level: p.displayOrder,
                borderWidth: 3,
                shadow: {
                    enabled: true,
                    color: 'rgba(0,0,0,0.3)',
                    size: 15,
                    x: 5,
                    y: 5
                },
                opacity: p.mort ? 0.7 : 1
            };
        })
    );

    // Construction des arêtes
    const edgesList = [];
    
    // Parent-enfant - lignes épaisses en bleu
    personnes.forEach(p => {
        if (p.pere !== null) edgesList.push({ 
            from: p.pere, 
            to: p.id,
            color: { color: '#3B82F6', highlight: '#1E40AF' },
            smooth: { type: 'cubicBezier', forceDirection: 'vertical' },
            width: 3,
            shadow: { enabled: true, color: 'rgba(59, 130, 246, 0.3)', size: 10, x: 3, y: 3 }
        });
        if (p.mere !== null) edgesList.push({ 
            from: p.mere, 
            to: p.id,
            color: { color: '#3B82F6', highlight: '#1E40AF' },
            smooth: { type: 'cubicBezier', forceDirection: 'vertical' },
            width: 3,
            shadow: { enabled: true, color: 'rgba(59, 130, 246, 0.3)', size: 10, x: 3, y: 3 }
        });
    });

    // Couples - lignes pointillées en rouge
    const seenCouples = new Set();
    personnes.forEach(p => {
        p.partenaires.forEach(sp => {
            const key = [p.id, sp].sort().join('-');
            if (!seenCouples.has(key)) {
                seenCouples.add(key);
                edgesList.push({ 
                    from: p.id, 
                    to: sp, 
                    dashes: [8, 6],
                    color: { color: '#EF4444', highlight: '#991B1B' },
                    smooth: { type: 'cubicBezier' },
                    width: 3.5,
                    shadow: { enabled: true, color: 'rgba(239, 68, 68, 0.3)', size: 10, x: 3, y: 3 }
                });
            }
        });
    });

    const edges = new vis.DataSet(edgesList);

    // Initialisation du réseau
    const container = document.getElementById('tree');
    const data = { nodes, edges };
    const options = {
        layout: { 
            hierarchical: { 
                direction: 'UD', 
                sortMethod: 'directed',
                nodeSpacing: 250,
                levelSeparation: 150,
                blockSize: 150
            } 
        },
        edges: { 
            smooth: { type: 'cubicBezier', forceDirection: 'vertical' },
            width: 3
        },
        physics: false,
        interaction: {
            navigationButtons: true,
            keyboard: true,
            zoomView: true,
            dragView: true,
            hover: true
        },
        manipulation: {
            enabled: false
        }
    };
    
    const network = new vis.Network(container, data, options);
    network.fit({ animation: { duration: 1000, easingFunction: 'easeInOutQuad' } });

    // Double-clic pour éditer
    network.on('doubleClick', function(params) {
        if (params.nodes.length > 0) {
            const personId = params.nodes[0];
            window.location.href = '/personne/' + personId + '/update';
        }
    });

    // Hover effect
    network.on('hoverNode', function(params) {
        container.style.cursor = 'pointer';
    });

    network.on('blurNode', function(params) {
        container.style.cursor = 'default';
    });
</script>
{% endblock %}